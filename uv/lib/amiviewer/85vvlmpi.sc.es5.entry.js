var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function r(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(r,a)}l((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var n,i,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,i=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=(o=r.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(e){s=[6,e],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};amiviewer.loadBundle("85vvlmpi",["exports"],function(e){var t,n=this,i=window.amiviewer.h;!function(e){e.NULL="NULL",e.ERROR="ERROR",e.APP_SET_SRC="APP_SET_SRC",e.APP_SET_SRC_LOADED="APP_SET_SRC_LOADED",e.APP_SET_DISPLAY="APP_SET_DISPLAY",e.APP_SET_ORIENTATION="APP_SET_ORIENTATION",e.APP_SET_TOOLS_VISIBLE="APP_SET_TOOLS_VISIBLE",e.APP_SET_TOOLS_ENABLED="APP_SET_TOOLS_ENABLED",e.APP_SET_TOOL_TYPE="APP_SET_TOOL_TYPE",e.APP_SET_OPTIONS_VISIBLE="APP_SET_OPTIONS_VISIBLE",e.APP_SET_OPTIONS_ENABLED="APP_SET_OPTIONS_ENABLED",e.APP_SET_BOUNDINGBOX_VISIBLE="APP_SET_BOUNDINGBOX_VISIBLE",e.APP_SET_THREEJS_SCENE_NEEDS_UPDATE="APP_SET_THREEJS_SCENE_NEEDS_UPDATE",e.APP_SET_SLICES_INDEX="APP_SET_SLICES_INDEX",e.APP_SET_SLICES_WINDOW_WIDTH="APP_SET_SLICES_WINDOW_WIDTH",e.APP_SET_SLICES_WINDOW_CENTER="APP_SET_SLICES_WINDOW_CENTER",e.APP_SET_VOLUME_STEPS="APP_SET_VOLUME_STEPS",e.APP_SET_VOLUME_WINDOW_WIDTH="APP_SET_VOLUME_WINDOW_WIDTH",e.APP_SET_VOLUME_WINDOW_CENTER="APP_SET_VOLUME_WINDOW_CENTER",e.APP_SET_ANGLE_TOOL_ENABLED="APP_SET_ANGLE_TOOL_ENABLED",e.APP_SET_ANNOTATION_TOOL_ENABLED="APP_SET_ANNOTATION_TOOL_ENABLED",e.APP_SET_RULER_TOOL_ENABLED="APP_SET_RULER_TOOL_ENABLED"}(t||(t={}));var o=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_SRC,payload:e})]})})}},s=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_SRC_LOADED,payload:e})]})})}},r=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_DISPLAY,payload:e})]})})}},a=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_ORIENTATION,payload:e})]})})}},l=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_TOOLS_VISIBLE,payload:e})]})})}},h=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_TOOLS_ENABLED,payload:e})]})})}},c=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_TOOL_TYPE,payload:e})]})})}},d=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_OPTIONS_VISIBLE,payload:e})]})})}},u=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_OPTIONS_ENABLED,payload:e})]})})}},_=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_BOUNDINGBOX_VISIBLE,payload:e})]})})}},p=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_THREEJS_SCENE_NEEDS_UPDATE,payload:e})]})})}},f=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_SLICES_INDEX,payload:e})]})})}},y=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_SLICES_WINDOW_WIDTH,payload:e})]})})}},m=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_SLICES_WINDOW_CENTER,payload:e})]})})}},E=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_VOLUME_STEPS,payload:e})]})})}},g=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_VOLUME_WINDOW_WIDTH,payload:e})]})})}},v=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_VOLUME_WINDOW_CENTER,payload:e})]})})}},b=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_ANGLE_TOOL_ENABLED,payload:e})]})})}},w=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_ANNOTATION_TOOL_ENABLED,payload:e})]})})}},S=function(e){return function(i,o){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(n){return[2,i({type:t.APP_SET_RULER_TOOL_ENABLED,payload:e})]})})}},T=function(e){var t,n=("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()).Symbol;return"function"==typeof n?n.observable?t=n.observable:(t=n("observable"),n.observable=t):t="@@observable",t}(),P=function(){return Math.random().toString(36).substring(7).split("").join(".")},O={INIT:"@@redux/INIT"+P(),REPLACE:"@@redux/REPLACE"+P(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+P()}};function L(e,t,n){var i;if("function"==typeof t&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function");if("function"==typeof t&&void 0===n&&(n=t,t=void 0),void 0!==n){if("function"!=typeof n)throw new Error("Expected the enhancer to be a function.");return n(L)(e,t)}if("function"!=typeof e)throw new Error("Expected the reducer to be a function.");var o=e,s=t,r=[],a=r,l=!1;function h(){a===r&&(a=r.slice())}function c(){if(l)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return s}function d(e){if("function"!=typeof e)throw new Error("Expected the listener to be a function.");if(l)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");var t=!0;return h(),a.push(e),function(){if(t){if(l)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");t=!1,h();var n=a.indexOf(e);a.splice(n,1)}}}function u(e){if(!function(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}(e))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(l)throw new Error("Reducers may not dispatch actions.");try{l=!0,s=o(s,e)}finally{l=!1}for(var t=r=a,n=0;n<t.length;n++)(0,t[n])();return e}return u({type:O.INIT}),(i={dispatch:u,subscribe:d,getState:c,replaceReducer:function(e){if("function"!=typeof e)throw new Error("Expected the nextReducer to be a function.");o=e,u({type:O.REPLACE})}})[T]=function(){var e,t=d;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function n(){e.next&&e.next(c())}return n(),{unsubscribe:t(n)}}})[T]=function(){return this},e},i}function D(e,t){var n=t&&t.type;return"Given "+(n&&'action "'+String(n)+'"'||"an action")+', reducer "'+e+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function x(e){return function(t){var n=t.dispatch,i=t.getState;return function(t){return function(o){return"function"==typeof o?o(n,i,e):t(o)}}}}var C,H,A,N=x();N.withExtraArgument=x,function(e){e.SLICES="slices",e.VOLUME="volume",e.MESH="mesh"}(C||(C={})),function(e){e.CORONAL="coronal",e.SAGGITAL="saggital",e.AXIAL="axial"}(H||(H={})),function(e){e.NONE="none",e.RULER="ruler",e.ANGLE="angle",e.ANNOTATION="annotation",e.HANDLE="handle"}(A||(A={}));var R=function(e){for(var t=Object.keys(e),n={},i=0;i<t.length;i++){var o=t[i];"function"==typeof e[o]&&(n[o]=e[o])}var s,r=Object.keys(n);try{!function(e){Object.keys(e).forEach(function(t){var n=e[t];if(void 0===n(void 0,{type:O.INIT}))throw new Error('Reducer "'+t+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===n(void 0,{type:O.PROBE_UNKNOWN_ACTION()}))throw new Error('Reducer "'+t+"\" returned undefined when probed with a random type. Don't try to handle "+O.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')})}(n)}catch(e){s=e}return function(e,t){if(void 0===e&&(e={}),s)throw s;for(var i=!1,o={},a=0;a<r.length;a++){var l=r[a],h=e[l],c=(0,n[l])(h,t);if(void 0===c){var d=D(l,t);throw new Error(d)}o[l]=c,i=i||c!==h}return i?o:e}}({app:function(e,n){switch(void 0===e&&(e={src:null,srcLoaded:!1,display:C.MESH,orientation:H.CORONAL,toolsVisible:!1,toolsEnabled:!1,toolType:A.NONE,optionsVisible:!1,optionsEnabled:!1,boundingBoxVisible:!1,THREEJSSceneNeedsUpdate:!1,slicesIndex:void 0,slicesWindowWidth:void 0,slicesWindowCenter:void 0,volumeSteps:void 0,volumeWindowWidth:void 0,volumeWindowCenter:void 0,angleToolEnabled:!0,annotationToolEnabled:!0,rulerToolEnabled:!0}),n.type){case t.APP_SET_SRC:return Object.assign({},e,{src:n.payload,srcLoaded:!1});case t.APP_SET_SRC_LOADED:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,srcLoaded:n.payload});case t.APP_SET_DISPLAY:return Object.assign({},e,{boundingBoxVisible:n.payload===C.SLICES,display:n.payload});case t.APP_SET_ORIENTATION:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,slicesIndex:void 0,orientation:n.payload});case t.APP_SET_TOOLS_VISIBLE:return Object.assign({},e,{toolsVisible:n.payload});case t.APP_SET_TOOLS_ENABLED:return Object.assign({},e,{toolsEnabled:n.payload});case t.APP_SET_TOOL_TYPE:return Object.assign({},e,{toolType:n.payload});case t.APP_SET_OPTIONS_VISIBLE:return Object.assign({},e,{optionsVisible:n.payload});case t.APP_SET_OPTIONS_ENABLED:return Object.assign({},e,{optionsEnabled:n.payload});case t.APP_SET_BOUNDINGBOX_VISIBLE:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,boundingBoxVisible:n.payload});case t.APP_SET_THREEJS_SCENE_NEEDS_UPDATE:return Object.assign({},e,{THREEJSSceneNeedsUpdate:n.payload});case t.APP_SET_SLICES_INDEX:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,slicesIndex:n.payload});case t.APP_SET_SLICES_WINDOW_WIDTH:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,slicesWindowWidth:n.payload});case t.APP_SET_SLICES_WINDOW_CENTER:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,slicesWindowCenter:n.payload});case t.APP_SET_VOLUME_STEPS:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,volumeSteps:n.payload});case t.APP_SET_VOLUME_WINDOW_WIDTH:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,volumeWindowWidth:n.payload});case t.APP_SET_VOLUME_WINDOW_CENTER:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,volumeWindowCenter:n.payload});case t.APP_SET_ANGLE_TOOL_ENABLED:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,angleToolEnabled:n.payload});case t.APP_SET_ANNOTATION_TOOL_ENABLED:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,annotationToolEnabled:n.payload});case t.APP_SET_RULER_TOOL_ENABLED:return Object.assign({},e,{THREEJSSceneNeedsUpdate:!0,rulerToolEnabled:n.payload})}return e}}),I=function(){};I.WIDGET_SIZE=200,I.colorValues={red:16056407,blue:45311,black:0,white:16777215,yellow:16771899,green:7798531,lightRed:16217975},I.lightValues={ambientLightColor:13684944,ambientLightIntensity:1,directionalLight1Color:16777215,directionalLight1Intensity:.75,directionalLight2Color:10584,directionalLight2Intensity:.5},I.cameraValues={near:.05,far:1e4,fov:45},I.stlValues={color:16007990,specular:1118481,shininess:200};var W,V=function(e){function t(t,n,i,o,s,r){void 0===r&&(r=null);var a=e.call(this)||this;if(a._instanceData={line:null,label:null,moving:!1},a._doesSnap=o,a._maxDistance=s,a._colors={default:I.colorValues.blue,active:I.colorValues.yellow,hover:I.colorValues.red,select:I.colorValues.green,text:I.colorValues.white,error:I.colorValues.lightRed},a._color=a._colors.default,a._controls=t,a._camera=t.object,a._container=n,a._toolParams=i.toolParams,a._enabled=!0,a._displayed=!0,a._selected=!1,a._active=!0,a._dragged=!1,a._hovered=!0,a._initialized=!1,a._dom=null,a._handles=[],a._material=null,a._geometry=null,a._mesh=null,a._toolParams.hideMesh&&(a.visible=!1),null===document.getElementById("ami-widgets")){var l=document.createElement("style");l.id="ami-widgets",l.innerHTML=AMI.WidgetsCss.code,document.head.appendChild(l)}return a._worldPosition=new THREE.Vector3,a._widgetType=i.toolType,i.worldPosition&&a._worldPosition.copy(i.worldPosition),a._worldNormal=new THREE.Vector3,a._widgetType=i.toolType,i.worldNormal&&a._worldNormal.copy(i.worldNormal),a._boundingScale=z.getBoundingMag(a._toolParams.boundingBoxGeometry)/I.WIDGET_SIZE,a._initialize(i,r),a.create(),a}return __extends(t,e),Object.defineProperty(t.prototype,"worldNormal",{get:function(){return this._worldNormal},set:function(e){this._worldNormal=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},set:function(e){this._mesh=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"widgetType",{get:function(){return this._widgetType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{get:function(){return this._worldPosition},set:function(e){this._worldPosition.copy(e),this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{get:function(){return this._selected},set:function(e){this._selected=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayed",{get:function(){return this._displayed},set:function(e){this._displayed=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"active",{get:function(){return this._active},set:function(e){this._active=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dragged",{get:function(){return this._dragged},set:function(e){this._dragged=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovered",{get:function(){return this._hovered},set:function(e){this._hovered=e,this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(e){this._color=e,this.update()},enumerable:!0,configurable:!0}),t.prototype.flushState=function(){(this._widgetType===A.NONE||A.HANDLE)&&(this._handles.forEach(function(e){e.flushState()}),this._enabled=!0,this._displayed=!0,this._selected=!1,this._active=!1,this._dragged=!1,this._hovered=!1,this.update())},t.prototype.updateMeshColor=function(){this._material&&this._material.color.set(this._color)},t.prototype.updateColor=function(){this._color=this._active?this._colors.active:this._hovered?this._colors.hover:this._selected?this._colors.select:this._colors.default},t.prototype.updateLabelTransform=function(e,t,n){var i=Math.round(t.x-(n?0:e.offsetWidth/2)),o=Math.round(t.y-(n?0:e.offsetHeight/2))-this._container.offsetHeight;return i<0?i=i>-e.offsetWidth?0:i+e.offsetWidth:i>this._container.offsetWidth-e.offsetWidth&&(i=i<this._container.offsetWidth?this._container.offsetWidth-e.offsetWidth:i-e.offsetWidth),o<-this._container.offsetHeight?o=o>-this._container.offsetHeight-e.offsetHeight?-this._container.offsetHeight:o+e.offsetHeight:o>-e.offsetHeight&&(o=o<0?-e.offsetHeight:o-e.offsetHeight),new THREE.Vector2(i,o)},t.prototype.updateDOMColor=function(){(this._widgetType===A.NONE||A.HANDLE)&&(this._instanceData.label.style.borderColor=this._color,this._instanceData.line.style.backgroundColor=this._color),this._updateDOMColor()},t.prototype.updateDOM=function(){this.updateDOMColor(),this._updateDOM()},t.prototype.updateMeshPosition=function(){this._geometry&&(this._geometry.verticesNeedUpdate=!0),this._updateMeshPosition()},t.prototype.update=function(){this.updateColor(),this._update(),(this._widgetType!==A.HANDLE||A.NONE)&&this._handles.forEach(function(e){e.update()}),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()},t.prototype.create=function(){this.createMesh(),this.createDOM(),this._createScreenOffsets(),this._createEventBindings(),this._createEventListeners()},t.prototype._createScreenOffsets=function(){var e=this._container.getBoundingClientRect(),t=document.body,n=document.documentElement,i=window.pageYOffset||n.scrollTop||t.scrollTop,o=window.pageXOffset||n.scrollLeft||t.scrollLeft,s=n.clientLeft||t.clientLeft||0;this._screenOffsets={top:Math.round(e.top+i-(n.clientTop||t.clientTop||0)),left:Math.round(e.left+o-s)}},t.prototype._createEventBindings=function(){this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this._createUniqueBindings()},t.prototype._createEventListeners=function(){window.addEventListener("resize",this.onResize),this._container.addEventListener("wheel",this.onMove),this._createUniqueListeners()},t.prototype.createMesh=function(){this._createMesh()},t.prototype._createMeshAsLine=function(){this._material=new THREE.LineBasicMaterial,this._toolParams.displayMode!==C.VOLUME&&(this._material.depthTest=!1),this.updateMeshColor(),this._geometry=new THREE.Geometry,this._geometry.vertices.push(this._handles[0].worldPosition),this._geometry.vertices.push(this._handles[1].worldPosition),this.mesh=new THREE.Line(this._geometry,this._material),this.mesh.visible=!0,this.mesh.renderOrder=999,this.add(this.mesh)},t.prototype.createDOM=function(){(this._widgetType===A.NONE||A.HANDLE)&&(this._instanceData.line=z.createDOMLine(this._container),this._instanceData.label=z.createDOMLabel(this._container)),this._createDOM(),this.updateDOMColor()},t.prototype.showDOM=function(){this._dom.style.display="",(this._widgetType===A.NONE||A.HANDLE)&&(this._handles.forEach(function(e){return e.showDOM()}),this._instanceData.line.style.display="",this._instanceData.label.style.display=""),this._showDOM()},t.prototype.hideDOM=function(){this._dom.style.display="none",(this._widgetType===A.NONE||A.HANDLE)&&(this._handles.forEach(function(e){return e.hideDOM()}),this._instanceData.line.style.display="none",this._instanceData.label.style.display="none"),this._hideDOM()},t.prototype.hideMesh=function(){this.visible=!1},t.prototype.showMesh=function(){!0!==this._toolParams.hideMesh&&(this.visible=!0)},t.prototype.show=function(){this.showDOM(),this.showMesh(),this.update(),this._displayed=!0},t.prototype.hide=function(){this.hideDOM(),this.hideMesh(),this._displayed=!1},t.prototype.hoverDom=function(e){this._domHovered="mouseenter"===e.type},t.prototype.onResize=function(){this._createScreenOffsets()},t.prototype.onMove=function(e){this._active?this._dragged=!0:this.onHover(null),(this._widgetType!==A.HANDLE||A.NONE)&&this._handles.forEach(function(t){t.onMove(e)}),this.update()},t.prototype.getMousePosition=function(e,t){return{x:(e.clientX-this._screenOffsets.left)/t.offsetWidth*2-1,y:-(e.clientY-this._screenOffsets.top)/t.offsetHeight*2+1,screenX:e.clientX-this._screenOffsets.left,screenY:e.clientY-this._screenOffsets.top}},t.prototype.setDefaultColor=function(e){this._colors.default=e,this._handles&&this._handles.forEach(function(t){return t._colors.default=e}),this.update()},t.prototype.free=function(){this._camera=null,this._container=null,this._controls=null,this._toolParams=null},t}(THREE.Object3D),k=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"raycaster",{get:function(){return this._raycaster},set:function(e){this._raycaster=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"screenPosition",{get:function(){return this._screenPosition},set:function(e){this._screenPosition=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tracking",{get:function(){return this._tracking},set:function(e){this._tracking=e,this.update()},enumerable:!0,configurable:!0}),t.prototype._updateDOM=function(){this._dom&&(this._dom.style.transform="translate3D("+this._screenPosition.x+"px,\n        "+(this._screenPosition.y-this._container.offsetHeight)+"px, 0)")},t.prototype._updateDOMColor=function(){this._dom.style.borderColor=this._color},t.prototype._update=function(){this._dragged&&this._active||this._surfaceLockHandle(null),this._screenPosition=z.worldToScreen(this._worldPosition,this._camera,this._container)},t.prototype._updateMeshPosition=function(){this.mesh&&this.mesh.position.copy(this._worldPosition)},t.prototype._createPlane=function(){this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.ray.position=this._raycaster.ray.origin,this._active=!0,this._controls.enabled=!1,this._plane.position.copy(this._worldPosition),this._plane.direction.copy(this._camera.getWorldDirection(this._plane.direction));var e=AMI.IntersectionsCore.rayPlane(this._raycaster.ray,this._plane);null!==e&&this._offset.copy(e).sub(this._plane.position)},t.prototype._createUniqueBindings=function(){this.onResize=this.onResize.bind(this)},t.prototype._createUniqueListeners=function(){window.addEventListener("resize",this.onResize),this._dom.addEventListener("mouseenter",this.onHover),this._dom.addEventListener("mouseleave",this.onHover)},t.prototype._createDOM=function(){this._dom=document.createElement("div"),this._dom.className="widgets-handle",this._dom.style.transform="translate3D(\n      "+this._screenPosition.x+"px,\n      "+(this._screenPosition.y-this._container.offsetHeight)+"px, 0)",this._container.appendChild(this._dom)},t.prototype._createMesh=function(){this._geometry=new THREE.SphereGeometry(1*this._boundingScale,16,16),this._material=new THREE.MeshBasicMaterial({wireframe:!0,wireframeLinewidth:2}),this._toolParams.displayMode!==C.VOLUME&&(this._material.depthTest=!1),this.updateMeshColor(),this.mesh=new THREE.Mesh(this._geometry,this._material),this.mesh.position.copy(this._worldPosition),this.mesh.visible=!0,this.mesh.renderOrder=999,this.add(this.mesh)},t.prototype._hideDOM=function(){},t.prototype._showDOM=function(){},t.prototype.hoverMesh=function(){var e=this._raycaster.intersectObject(this.mesh);this._meshHovered=e.length>0},t.prototype.onHover=function(e){e&&this.hoverDom(e),this.hoverMesh(),this._hovered=this._meshHovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"},t.prototype.onMove=function(e){var t=this.getMousePosition(e,this._container);if(this._mouse.set(t.x,t.y),this._active){if(this._dragged=!0,!this._surfaceLockHandle(e)){if(this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.ray.position=this._raycaster.ray.origin,0===this._plane.direction.length()){var n=new THREE.Vector3;this._camera.getWorldDirection(n),this._plane.position.copy(this._worldPosition),this._plane.direction.copy(n)}var i=AMI.IntersectionsCore.rayPlane(this._raycaster.ray,this._plane);null!==i&&this._worldPosition.copy(i.sub(this._offset))}}else this.onHover(null);this.update()},t.prototype.onStart=function(e){var t=this.getMousePosition(e,this._container);this._mouse.set(t.x,t.y),this._hovered&&(this._toolParams.displayMode===C.VOLUME&&(this._locked=!0),this._createPlane(),this.update())},t.prototype.onEnd=function(){!0!==this._tracking&&(!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected),this._initialized=!0,this._active=!1,this._dragged=!1,this._controls.enabled=!0,this._toolParams.displayMode===C.VOLUME&&(this._locked=!0),this.update())},t.prototype._surfaceLockHandle=function(e){if(this._doesSnap&&!this._locked){var t=null;if(e){var n=z.getScreenspaceOffsets(this._container),i={x:(e.clientX-n.left)/this._container.offsetWidth*2-1,y:-(e.clientY-n.top)/this._container.offsetHeight*2+1};this._raycaster.far=1e4,this._raycaster.setFromCamera(i,this._camera),t=this._camera}else this._raycaster.far=this._maxDistance,this._raycaster.set(this._worldPosition,this.worldNormal.negate());var o=z.castRay(this._raycaster,this._toolParams.displayMode,this._sceneCenter,t,this._toolParams.stackHelper,this._toolParams.loadedDataParent);return!(!o||(o.hitNormal&&this.worldNormal.copy(o.hitNormal),!o.hitPosition)||(this._worldPosition.copy(o.hitPosition),0))}},t.prototype._initialize=function(e,t){this._locked=!1,this._raycaster=new THREE.Raycaster,this._mouse=new THREE.Vector2,this._plane={position:new THREE.Vector3,direction:new THREE.Vector3},this._offset=new THREE.Vector3,this._sceneCenter=z.getGeometryCenter(this._toolParams.boundingBoxGeometry),this._screenPosition=z.worldToScreen(this._worldPosition,this._camera,this._container)},t.prototype._removeEventListeners=function(){window.removeEventListener("resize",this.onResize),this._dom.removeEventListener("mouseenter",this.onHover),this._dom.removeEventListener("mouseleave",this.onHover),this._container.removeEventListener("wheel",this.onMove)},t.prototype.free=function(){this._removeEventListeners(),this._container.removeChild(this._dom),this.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.geometry=null,this.mesh.material.dispose(),this.mesh.material=null,this.mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,e.prototype.free.call(this)},t}(V),B=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"worldPosition",{set:function(e){this._handles[0].worldPosition.copy(e),this._handles[1].worldPosition.copy(e),this._handles[2].worldPosition.copy(e),this._worldPosition.copy(e),this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._serials.angle},enumerable:!0,configurable:!0}),t.prototype._updateDOMColor=function(){this._line2.style.backgroundColor=this._color},t.prototype._updateMeshPosition=function(){},t.prototype._update=function(){this._serials.angle=180*this._handles[1].worldPosition.clone().sub(this._handles[0].worldPosition).angleTo(this._handles[1].worldPosition.clone().sub(this._handles[2].worldPosition))/Math.PI||0},t.prototype._updateDOM=function(){var e=z.getLineData(this._handles[1].screenPosition,this._handles[0].screenPosition,this._container);this._instanceData.line.style.transform="translate3D("+e.transformX+"px, "+e.transformY+"px, 0)\n            rotate("+e.transformAngle+"rad)",this._instanceData.line.style.width=e.length+"px";var t=z.getLineData(this._handles[1].screenPosition,this._handles[2].screenPosition,this._container);this._line2.style.transform="translate3D("+t.transformX+"px, "+t.transformY+"px, 0)\n            rotate("+t.transformAngle+"rad)",this._line2.style.width=t.length+"px",this._instanceData.label.innerHTML=this._serials.angle.toFixed(2)+"&deg;";var n=e.line.clone().add(t.line).normalize().negate(),i=n.angleTo(new THREE.Vector3(1,0,0));i>Math.PI/2&&(i=Math.PI-i);var o=Math.tan(i)<this._instanceData.label.offsetHeight/this._instanceData.label.offsetWidth?this._instanceData.label.offsetWidth/2/Math.cos(i)+15:this._instanceData.label.offsetHeight/2/Math.cos(Math.PI/2-i)+15,s=this._handles[1].screenPosition.clone().add(n.multiplyScalar(o)),r=this.updateLabelTransform(this._instanceData.label,s);this._instanceData.label.style.transform="translate3D("+r.x+"px, "+r.y+"px, 0)"},t.prototype._createUniqueBindings=function(){},t.prototype._createUniqueListeners=function(){},t.prototype._createDOM=function(){this._line2=z.createDOMLine(this._container)},t.prototype._createMesh=function(){this._geometry=new THREE.Geometry,this._geometry.vertices=[this._handles[0].worldPosition,this._handles[1].worldPosition,this._handles[1].worldPosition,this._handles[2].worldPosition],this._material=new THREE.LineBasicMaterial,this._toolParams.displayMode!==C.VOLUME&&(this._material.depthTest=!1),this.updateMeshColor(),this.mesh=new THREE.LineSegments(this._geometry,this._material),this.mesh.visible=!0,this.mesh.renderOrder=999,this.add(this.mesh)},t.prototype._hideDOM=function(){this._line2.style.display="none"},t.prototype._showDOM=function(){this._line2.style.display=""},t.prototype.onHover=function(e){e&&this.hoverDom(e),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._handles[2].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"},t.prototype.onStart=function(e){this._handles[0].onStart(e),this._handles[1].onStart(e),this._handles[2].onStart(e),this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._domHovered,!this._domHovered||this._handles[1].tracking||this._handles[2].tracking||(this._instanceData.moving=!0,this._controls.enabled=!1),this.update()},t.prototype.onMove=function(e){this._active?this._dragged=!0:this.onHover(null),this._handles[0].onMove(e),this._handles[1].onMove(e),this._handles[2].onMove(e),this.update()},t.prototype.onEnd=function(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||!this._handles[1].tracking&&this._handles[2].tracking&&this._handles[1].screenPosition.distanceTo(this._handles[2].screenPosition)<10||(this._dragged||!this._active||this._handles[2].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._handles[1].active?this._handles[2].onEnd():this._dragged||!this._handles[2].tracking?(this._handles[2].tracking=!1,this._handles[2].onEnd()):this._handles[2].tracking=!1,this._handles[2].selected=this._selected,this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active,this._dragged=this._handles[2].tracking,this._instanceData.moving=!1,this.update())},t.prototype._initialize=function(e,t){this._serials=t||{angle:0};var n=e;n.toolType=A.HANDLE;for(var i=0;i<3;i++){var o=new k(this._controls,this._container,n,!0,this._maxDistance);this.add(o),this._handles.push(o)}this._handles[1].active=!0,this._handles[1].tracking=!0,this._handles[2].active=!0,this._handles[2].tracking=!0},t.prototype._removeEventListeners=function(){this._container.removeEventListener("wheel",this.onMove)},t.prototype.free=function(){var t=this;this._removeEventListeners(),this._handles.forEach(function(e){t.remove(e),e.free()}),this._handles=[],this._container.removeChild(this._instanceData.line),this._container.removeChild(this._line2),this._container.removeChild(this._instanceData.label),this.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.geometry=null,this.mesh.material.dispose(),this.mesh.material=null,this.mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,e.prototype.free.call(this)},t}(V),U=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"worldPosition",{set:function(e){this._handles[0].worldPosition.copy(e),this._handles[1].worldPosition.copy(e),this._worldPosition.copy(e),this.update()},enumerable:!0,configurable:!0}),t.prototype._updateDOM=function(){this.updateDOMColor();var e=z.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition,this._container);this._instanceData.line.style.transform="translate3D("+e.transformX+"px, "+e.transformY+"px, 0)\n        rotate("+e.transformAngle+"rad)",this._instanceData.line.style.width=e.length+"px";var t=e.line.multiplyScalar(.5),n=this._handles[1].screenPosition.clone().sub(this._labelMoved?this._labelOffset:t),i=this.updateLabelTransform(this._instanceData.label,n);this._instanceData.label.style.transform="translate3D("+i.x+"px, "+i.y+"px, 0)",this._manuallabeldisplay&&this._displaylabel();var o=z.getLineData(this._handles[0].screenPosition,n,this._container),s=z.getLineData(e.center,n,this._container),r=z.getLineData(this._handles[1].screenPosition,n,this._container);o.length>s.length&&(o=s),o.length>r.length&&(o=r),this._dashLine.style.transform="translate3D("+o.transformX+"px, "+o.transformY+"px, 0)\n        rotate("+o.transformAngle+"rad)",this._dashLine.style.width=o.length+"px"},t.prototype._updateDOMColor=function(){this._dashLine.style.borderTop="1.5px dashed "+this._color},t.prototype._update=function(){},t.prototype._updateMeshPosition=function(){this._worldPosition=this._handles[0].worldPosition,this._cone&&(this._cone.position.copy(this._handles[0].worldPosition),this._cone.lookAt(this._handles[1].worldPosition))},t.prototype._createUniqueBindings=function(){this.onResize=this.onResize.bind(this),this.notonHover=this.notonHover.bind(this),this._changelabeltext=this._changelabeltext.bind(this)},t.prototype._createUniqueListeners=function(){this._instanceData.label.addEventListener("mouseenter",this.onHover),this._instanceData.label.addEventListener("mouseleave",this.notonHover),this._instanceData.label.addEventListener("dblclick",this._changelabeltext)},t.prototype._createDOM=function(){this._dashLine=document.createElement("div"),this._dashLine.className="widgets-dashline",this._dashLine.style.display="none",this._container.appendChild(this._dashLine),this._instanceData.label.style.display="none"},t.prototype._createMesh=function(){this._createMeshAsLine(),this._coneGeometry=new THREE.CylinderGeometry(0,2*this._boundingScale,10*this._boundingScale),this._coneGeometry.translate(0,-5*this._boundingScale,0),this._coneGeometry.rotateX(-Math.PI/2),this._cone=new THREE.Mesh(this._coneGeometry,this._material),this._cone.visible=!0,this.mesh.renderOrder=999,this.add(this._cone)},t.prototype._displaylabel=function(){this._instanceData.label.innerHTML="string"==typeof this._serials.labelText&&this._serials.labelText.length>0?this._serials.labelText:"",this._instanceData.label.style.display="",this._dashLine.style.display="",this._instanceData.label.style.transform="translate3D(\n        "+(this._handles[1].screenPosition.x-this._labelOffset.x-this._instanceData.label.offsetWidth/2)+"px,\n        "+(this._handles[1].screenPosition.y-this._labelOffset.y-this._instanceData.label.offsetHeight/2-this._container.offsetHeight)+"px, 0)"},t.prototype._hideDOM=function(){this._dashLine.style.display="none"},t.prototype._showDOM=function(){this._dashLine.style.display=""},t.prototype.notonHover=function(){this._labelHovered=!1,this._container.style.cursor="default"},t.prototype.onHover=function(){this._labelHovered=!0,this._container.style.cursor="pointer"},t.prototype.onStart=function(e){if(this._labelHovered){var t=this.getMousePosition(e,this._container),n=this._handles[1].screenPosition.clone().sub(this._labelOffset);this._mouseLabelOffset=new THREE.Vector3(t.screenX-n.x,t.screenY-n.y,0),this._instanceData.moving=!0,this._labelMoved=!0}this._handles[0].onStart(e),this._handles[1].onStart(e),this._active=this._handles[0].active||this._handles[1].active||this._labelHovered,this.update()},t.prototype.onMove=function(e){if(this._instanceData.moving){var t=this.getMousePosition(e,this._container);this._labelOffset=new THREE.Vector3(this._handles[1].screenPosition.x-t.screenX+this._mouseLabelOffset.x,this._handles[1].screenPosition.y-t.screenY+this._mouseLabelOffset.y,0),this._controls.enabled=!1}this._active&&(this._dragged=!0),this._handles[0].onMove(e),this._handles[1].onMove(e),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._labelHovered,this.update()},t.prototype.onEnd=function(){this._handles[0].onEnd(),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected,this._handles[0].selected=this._selected,this._handles[1].selected=this._selected),this._initialized||(this._labelOffset=this._handles[1].screenPosition.clone().sub(this._handles[0].screenPosition).multiplyScalar(.5),this._setlabeltext(),this._initialized=!0),this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._instanceData.moving=!1,this.update()},t.prototype._setlabeltext=function(){for(;!this._serials.labelText;)this._serials.labelText=prompt("Please enter the annotation text","");var e;e=this._camera.getWorldPosition(e);var t=this._handles[0].worldPosition.clone().sub(e).normalize().negate();this._handles[1].worldPosition.add(t.multiplyScalar(18*this._boundingScale)),this._handles[1].screenPosition=z.worldToScreen(this._handles[1].worldPosition,this._camera,this._container),this._displaylabel()},t.prototype._changelabeltext=function(){this._serials.labelText=prompt("Please enter a new annotation text",this._instanceData.label.innerHTML),this._displaylabel()},t.prototype._initialize=function(e,t){this._serials=t||{labelText:""};var n=e;n.toolType=A.HANDLE;var i=new k(this._controls,this._container,n,!0,this._maxDistance);this.add(i),this._handles.push(i);var o=new k(this._controls,this._container,n,!1,this._maxDistance);this.add(o),this._handles.push(o),this._handles[1].active=!0},t.prototype._removeEventListeners=function(){window.removeEventListener("resize",this.onResize),this._instanceData.label.removeEventListener("mouseenter",this.onHover),this._instanceData.label.removeEventListener("mouseleave",this.notonHover),this._instanceData.label.removeEventListener("dblclick",this._changelabeltext),this._container.removeEventListener("wheel",this.onMove)},t.prototype.free=function(){var t=this;this._removeEventListeners(),this._handles.forEach(function(e){t.remove(e),e.free()}),this._handles=[],this._container.removeChild(this._instanceData.line),this._container.removeChild(this._dashLine),this._container.removeChild(this._instanceData.label),this.remove(this.mesh),this.mesh.material.dispose(),this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this.mesh.material=null,this.mesh=null,this.remove(this._cone),this._cone.geometry.dispose(),this._cone.geometry=null,this._cone.material.dispose(),this._cone.material=null,this._cone=null,this._coneGeometry.dispose(),this._coneGeometry=null,e.prototype.free.call(this)},t}(V),j=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"calibrationFactor",{get:function(){return this._serials.calibrationFactor},set:function(e){this._serials.calibrationFactor=e,this._serials.units="mm",this.update()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worldPosition",{set:function(e){this._handles[0].worldPosition.copy(e),this._handles[1].worldPosition.copy(e),this._worldPosition.copy(e),this.update()},enumerable:!0,configurable:!0}),t.prototype._updateDOM=function(){var e=z.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition,this._container);this._instanceData.line.style.transform="translate3D("+e.transformX+"px, "+e.transformY+"px, 0)\n      rotate("+e.transformAngle+"rad)",this._instanceData.line.style.width=e.length+"px","units"!==this._serials.units||this._instanceData.label.hasAttribute("title")?"units"!==this._serials.units&&this._instanceData.label.hasAttribute("title")&&(this._instanceData.label.removeAttribute("title"),this._instanceData.label.style.color=this._colors.text):(this._instanceData.label.setAttribute("title","Calibration is required to display the distance in mm"),this._instanceData.label.style.color=this._colors.error),this._instanceData.label.innerHTML=this._serials.distance.toFixed(2)+" "+this._serials.units;var t=Math.abs(e.transformAngle);t>Math.PI/2&&(t=Math.PI-t);var n=Math.tan(t)<this._instanceData.label.offsetHeight/this._instanceData.label.offsetWidth?this._instanceData.label.offsetWidth/2/Math.cos(t)+15:this._instanceData.label.offsetHeight/2/Math.cos(Math.PI/2-t)+15,i=e.line.normalize().multiplyScalar(n),o=e.length>2*n?this._handles[1].screenPosition.clone().sub(i):this._handles[1].screenPosition.clone().add(i),s=this.updateLabelTransform(this._instanceData.label,o);this._instanceData.label.style.transform="translate3D("+s.x+"px, "+s.y+"px, 0)"},t.prototype._update=function(){var e=z.getDistanceData(this._handles[0].worldPosition,this._handles[1].worldPosition,this._serials.calibrationFactor);this._serials.distance=e.distance,e.units&&(this._serials.units=e.units)},t.prototype._updateMeshPosition=function(){},t.prototype._updateDOMColor=function(){},t.prototype._createUniqueBindings=function(){},t.prototype._createUniqueListeners=function(){},t.prototype._createDOM=function(){},t.prototype._createMesh=function(){this._createMeshAsLine()},t.prototype._hideDOM=function(){},t.prototype._showDOM=function(){},t.prototype.onHover=function(e){e&&this.hoverDom(e),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"},t.prototype.onStart=function(e){this._handles[0].onStart(e),this._handles[1].onStart(e),this._active=this._handles[0].active||this._handles[1].active||this._domHovered,this._domHovered&&!this._handles[1].tracking&&(this._instanceData.moving=!0,this._controls.enabled=!1),this.update()},t.prototype.onMove=function(e){this._active?this._dragged=!0:this.onHover(null),this._handles[0].onMove(e),this._handles[1].onMove(e),this.update()},t.prototype.onEnd=function(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._instanceData.moving=!1,this.update())},t.prototype.getMeasurements=function(){return{distance:this._serials.distance,units:this._serials.units}},t.prototype._initialize=function(e,t){this._serials=t||{calibrationFactor:1,units:"mm",distance:0},this._widgetType=A.RULER;var n=e;n.toolType=A.HANDLE;for(var i=0;i<2;i++){var o=new k(this._controls,this._container,n,!0,this._maxDistance);o.name=String(i),this.add(o),this._handles.push(o)}this._handles[1].active=!0,this._handles[1].tracking=!0,n.toolParams.hideMesh=!0},t.prototype._removeEventListeners=function(){this._container.removeEventListener("wheel",this.onMove)},t.prototype.free=function(){var t=this;this._removeEventListeners(),this._handles.forEach(function(e){t.remove(e),e.free()}),this._handles=[],this._container.removeChild(this._instanceData.line),this._container.removeChild(this._instanceData.label),this.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.geometry=null,this.mesh.material.dispose(),this.mesh.material=null,this.mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,e.prototype.free.call(this)},t}(V),z=function(){function e(){}return e.createDOMLine=function(e){var t=document.createElement("div");return t.className="widgets-line",e.appendChild(t),t},e.createDOMLabel=function(e){var t=document.createElement("div");return t.className="widgets-label",e.appendChild(t),t},e.worldToScreen=function(e,t,n){var i=e.clone();return i.project(t),i.x=Math.round((i.x+1)*n.offsetWidth/2),i.y=Math.round((1-i.y)*n.offsetHeight/2),i.z=0,i},e.getRectData=function(e,t,n){var i=t.clone().sub(e),o=i.clone().projectOnVector(new THREE.Vector3(0,1,0)),s=e.clone().min(t);return{width:i.clone().projectOnVector(new THREE.Vector3(1,0,0)).length(),height:o.length(),transformX:s.x,transformY:s.y-n.offsetHeight,paddingVector:o.clone().normalize()}},e.getLineData=function(e,t,n){var i=t.clone().sub(e),o=t.clone().add(e).multiplyScalar(.5),s=i.length(),r=i.angleTo(new THREE.Vector3(1,0,0));return{line:i,length:s,transformX:o.x-s/2,transformY:o.y-n.offsetHeight,transformAngle:e.y<t.y?r:-r,center:o}},e.getDistanceData=function(e,t,n){return{distance:n?e.distanceTo(t)*n:e.distanceTo(t),units:null}},e.getArea=function(e){for(var t=0,n=e.length-1,i=0;i<e.length;i++)t+=(e[n].x+e[i].x)*(e[n].y-e[i].y),n=i;return Math.abs(t/2)},e.getBoundingBoxHelper=function(e,t,n){var i;switch(e){case C.MESH:i=t;break;case C.VOLUME:i=n._mesh;break;case C.SLICES:i=n._bBox}return new THREE.BoxHelper(i,new THREE.Color(I.colorValues.red))},e.getScreenspaceOffsets=function(e){var t=e.getBoundingClientRect(),n=document.body,i=document.documentElement,o=window.pageYOffset||i.scrollTop||n.scrollTop,s=window.pageXOffset||i.scrollLeft||n.scrollLeft,r=t.left+s-(i.clientLeft||n.clientLeft||0);return{top:Math.round(t.top+o-(i.clientTop||n.clientTop||0)),left:Math.round(r)}},e.castRay=function(e,t,n,i,o,s){switch(void 0===o&&(o=null),void 0===s&&(s=null),t){case C.MESH:if((a=e.intersectObjects(s.children)).length<=0)return null;var r=null;return i&&(r=a[0].point.clone().sub(i.position.clone()).normalize()),{hitPosition:a[0].point,hitNormal:r};case C.SLICES:var a;return(a=e.intersectObject(o.slice.mesh)).length<=0?null:(r=null,i&&(r=a[0].face.normal),{hitPosition:a[0].point,hitNormal:r});case C.VOLUME:var l=new THREE.Vector3(0,0,0);return r=new THREE.Vector3(0,0,0),0===function(e,t,n,i,o,s){var r=+t.x,a=+t.y,l=+t.z,h=+n.x,c=+n.y,d=+n.z,u=Math.sqrt(h*h+c*c+d*d);if(0===u)throw new Error("Can't raycast along a zero vector");return function(e,t,n,i,o,s,r,a,l,h){for(var c=0,d=Math.floor,u=0|d(t),_=0|d(n),p=0|d(i),f=o>0?1:-1,y=s>0?1:-1,m=r>0?1:-1,E=Math.abs(1/o),g=Math.abs(1/s),v=Math.abs(1/r),b=E<1/0?E*(f>0?u+1-t:t-u):1/0,w=g<1/0?g*(y>0?_+1-n:n-_):1/0,S=v<1/0?v*(m>0?p+1-i:i-p):1/0,T=e.windowCenter-.5*e.windowWidth,P=-1;c<=a;){var O,L=new THREE.Vector3(u,_,p),D=AMI.UtilsCore.worldToData(e.stack.lps2IJK,L),M=AMI.UtilsCore.getPixelData(e.stack,D);if(O=null!==M&&M>T?1:0)return l&&(l.x=t+c*o,l.y=n+c*s,l.z=i+c*r),h&&(h.x=h.y=h.z=0,0===P&&(h.x=-f),1===P&&(h.y=-y),2===P&&(h.z=-m)),O;b<w?b<S?(u+=f,c=b,b+=E,P=0):(p+=m,c=S,S+=v,P=2):w<S?(_+=y,c=w,w+=g,P=1):(p+=m,c=S,S+=v,P=2)}return l&&(l.x=t+c*o,l.y=n+c*s,l.z=i+c*r),h&&(h.x=h.y=h.z=0),0}(e,r,a,l,h/=u,c/=u,d/=u,i=void 0===i?64:+i,o,s)}(o,e.ray.origin,e.ray.direction,I.cameraValues.far,l,r)?null:{hitPosition:l,hitNormal:r=n.sub(l).normalize()}}return null},e.getGeometryCenter=function(e){var t;return(t=e instanceof THREE.BufferGeometry?(new THREE.Geometry).fromBufferGeometry(e):e).computeBoundingSphere(),t.boundingSphere.center},e.getBoundingBox=function(e){return(new THREE.Box3).setFromObject(e)},e.getBoundingMag=function(e){var t;return(t=e instanceof THREE.BufferGeometry?(new THREE.Geometry).fromBufferGeometry(e):e).computeBoundingSphere(),2*t.boundingSphere.radius},e.getCameraZ=function(t,n){return e.getBoundingMag(t)*n},e.createWidget=function(e,t,n,i,o){switch(void 0===o&&(o=null),n.toolType){case A.RULER:return{widget:new j(e,t,n,!1,i,o),activeHandles:2};case A.ANGLE:return{widget:new B(e,t,n,!1,i,o),activeHandles:3};case A.ANNOTATION:return{widget:new U(e,t,n,!1,i,o),activeHandles:1};default:return null}},e.initialiseCameraFromScene=function(t,n,i){t.computeBoundingBox();var o=t.boundingBox.max.z-t.boundingBox.min.z,s=2*Math.max(Math.max(t.boundingBox.max.x-t.boundingBox.min.x,t.boundingBox.max.y-t.boundingBox.min.y),o)/Math.tan(n.fov*Math.PI/180),r=e.getGeometryCenter(t),a={x:r.x,y:r.y,z:r.z+s};return i.target.set(r.x,r.y,r.z),n.position.set(a.x,a.y,a.z),n.lookAt(r.x,r.y,r.z),r},e.createPerspectiveCamera=function(e){return new THREE.PerspectiveCamera(I.cameraValues.fov,e.offsetWidth/e.offsetHeight,I.cameraValues.near,I.cameraValues.far)},e.createSceneLights=function(){var e=new THREE.Object3D,t=new THREE.DirectionalLight(I.lightValues.directionalLight1Color,I.lightValues.directionalLight1Intensity);t.position.set(1,1,1),e.add(t);var n=new THREE.DirectionalLight(I.lightValues.directionalLight2Color,I.lightValues.directionalLight2Intensity);n.position.set(-1,-1,-1),e.add(n);var i=new THREE.AmbientLight(I.lightValues.ambientLightColor,I.lightValues.ambientLightIntensity);return e.add(i),e},e}();!function(e){e.GLTF="gltf",e.STL="stl"}(W||(W={}));var G=function(){function e(){}return e.setup=function(e,t,n){var i,o=t.scene||t.scenes[0];o instanceof THREE.Mesh?i=o:o.children.forEach(function(e){e instanceof THREE.Mesh&&(i=e)});var s=i.geometry;s instanceof THREE.BufferGeometry&&(s=(new THREE.Geometry).fromBufferGeometry(i.geometry));var r=s.vertices.reduce(function(e,t){return new THREE.Vector3(Math.min(e.length(),t.length()),0,0)}).x;return n.gammaOutput=!0,e.add(i),r},e}(),J=function(){function e(){}return e.setup=function(e,t,n){null===t.boundingSphere&&t.computeBoundingSphere();var i=new THREE.MeshPhongMaterial(n),o=new THREE.Mesh(t,i),s=o.geometry;s instanceof THREE.BufferGeometry&&(s=(new THREE.Geometry).fromBufferGeometry(o.geometry));var r=s.vertices.reduce(function(e,t){return new THREE.Vector3(Math.min(e.length(),t.length()),0,0)}).x,a=new THREE.Matrix4;return a.set(-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),o.applyMatrix(a),e.add(o),r},e}(),X=function(){function e(){}return e.setupMesh=function(t,n,i){switch(e.FILE_EXTENSION){case W.GLTF:return G.setup(t,n,i);case W.STL:return J.setup(t,n,{color:I.stlValues.color,specular:I.stlValues.specular,shininess:I.stlValues.shininess});default:throw new Error("When setting 'src' to a mesh file you must set 'display' to 'mesh'")}},e.srcLoader=function(t){return new Promise(function(n,i){var o=new XMLHttpRequest;o.open("GET",t,!0),o.onload=function(){var t=JSON.parse(o.responseText);t=e.mapfiles(t.baseurl,t.series),n(t)},o.onerror=function(){i()},o.send()})},e.mapfiles=function(e,t){return t.map(function(t){return e.endsWith("/")||(e+="/"),""+e+t})},e.loadSrc=function(t,n,i){return new Promise(function(o){var s={obj:null,stack:null};e.srcLoader(t).then(function(t){e.loadObject(t,n,i).then(function(e){switch(n){case C.MESH:s.obj=e;break;default:s.stack=e}o(s)})})})},e.loadObject=function(t,n,i){var o=t[0];if(e.FILE_EXTENSION=o.substring(o.lastIndexOf(".")+1),Object.values(W).includes(e.FILE_EXTENSION)){if(n!==C.MESH)throw new Error("When setting 'src' to a mesh file you must set 'display' to 'mesh'");return e.loadMesh(o)}return e.loadSeries(t,i)},e.loadSeries=function(e,t){return new Promise(function(n){var i=new AMI.VolumeLoader(t);i.load(e).then(function(){var e=i.data[0].mergeSeries(i.data)[0].stack[0];i.free(),n(e)}).catch(function(e){console.log("DICOM load error"),console.error(e)})})},e.loadMesh=function(t){return new Promise(function(n){var i;switch(e.FILE_EXTENSION){case W.GLTF:i=new THREE.GLTFLoader,THREE.DRACOLoader.setDecoderPath(e.DRACO_DECODER_PATH),i.setDRACOLoader(new THREE.DRACOLoader);break;case W.STL:i=new THREE.STLLoader;break;default:throw new Error('Unrecognised mesh format. You may need to set display to "slices" or "volume"')}i.setCrossOrigin&&i.setCrossOrigin("anonymous"),i.load(t,function(e){n(e)},function(e){e.lengthComputable&&console.log("loading: ",e.loaded/e.total+"%")},function(e){console.error(e)})})},e}();X.FILE_EXTENSION=null,X.DRACO_DECODER_PATH=null;var F=function(){function e(){this._renderQuality=1,this._activeWidgets=0,this._deltaTime=0,this._displayChanged=!0,this._widgets=[],this.srcLoaded=!1}return e.prototype._reduceActive=function(){this._activeWidgets>0&&(this._activeWidgets-=1),this._flushWidgets(),this.display===C.VOLUME&&this._flushWidgets()},e.prototype._setActive=function(e){0===this._activeWidgets&&(this._activeWidgets=e)},e.prototype.watchSrcLoaded=function(){this._resetWidgets()},e.prototype.watchDisplay=function(){this._displayChanged=!0,this._resetWidgets()},e.prototype.watchOrientation=function(){this._resetWidgets()},e.prototype.setSrc=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetSrc(e),[2]})})},e.prototype.setToolsVisible=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetToolsVisible(e),[2]})})},e.prototype.setOptionsVisible=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetOptionsVisible(e),[2]})})},e.prototype.setDisplay=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetDisplay(e),[2]})})},e.prototype.setBoundingBoxVisible=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetBoundingBoxVisible(e),[2]})})},e.prototype.setAngleToolEnabled=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetAngleToolEnabled(e),[2]})})},e.prototype.setAnnotationToolEnabled=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetAnnotationToolEnabled(e),[2]})})},e.prototype.setRulerToolEnabled=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.appSetRulerToolEnabled(e),[2]})})},e.prototype.componentWillLoad=function(){this._widgetRaycaster=new THREE.Raycaster,this.store.setStore(L(R,{},function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){return function(){var n=e.apply(void 0,arguments),i=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},o={getState:n.getState,dispatch:function(){return i.apply(void 0,arguments)}},s=t.map(function(e){return e(o)});return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(t){M(e,t,n[t])})}return e}({},n,{dispatch:i=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})}.apply(void 0,s)(n.dispatch)})}}}(N))),this.store.mapStateToProps(this,function(e){var t=e.app;return{src:t.src,srcLoaded:t.srcLoaded,display:t.display,orientation:t.orientation,toolsVisible:t.toolsVisible,toolsEnabled:t.toolsEnabled,toolType:t.toolType,optionsVisible:t.optionsVisible,optionsEnabled:t.optionsEnabled,boundingBoxVisible:t.boundingBoxVisible,THREEJSSceneNeedsUpdate:t.THREEJSSceneNeedsUpdate,slicesIndex:t.slicesIndex,slicesWindowWidth:t.slicesWindowWidth,slicesWindowCenter:t.slicesWindowCenter,volumeSteps:t.volumeSteps,volumeWindowWidth:t.volumeWindowWidth,volumeWindowCenter:t.volumeWindowCenter,angleToolEnabled:t.angleToolEnabled,annotationToolEnabled:t.annotationToolEnabled,rulerToolEnabled:t.rulerToolEnabled}}),this.store.mapDispatchToProps(this,{appSetSrc:o,appSetSrcLoaded:s,appSetDisplay:r,appSetOrientation:a,appSetToolsVisible:l,appSetToolsEnabled:h,appSetToolType:c,appSetOptionsVisible:d,appSetOptionsEnabled:u,appSetBoundingBoxVisible:_,appSetTHREEJSSceneNeedsUpdate:p,appSetSlicesIndex:f,appSetSlicesWindowWidth:y,appSetSlicesWindowCenter:m,appSetVolumeSteps:E,appSetVolumeWindowWidth:g,appSetVolumeWindowCenter:v,appSetAngleToolEnabled:b,appSetAnnotationToolEnabled:w,appSetRulerToolEnabled:S}),X.DRACO_DECODER_PATH=this.dracoDecoderPath},e.prototype.componentDidLoad=function(){var e=this;window.addEventListener("resize",function(){e.resize()},!1),this.src&&X.loadSrc(this.src,this.display,this._canvasContainer).then(function(t){e._meshObject=t.obj,e._stack=t.stack,e.appSetSrcLoaded(!0)})},e.prototype.componentWillUpdate=function(){if(this.srcLoaded&&this._displayChanged)switch(this._lut=new AMI.LutHelper(this._lutCanvases),this._lut.luts=AMI.LutHelper.presetLuts(),this._lut.lutsO=AMI.LutHelper.presetLutsO(),this.display){case C.VOLUME:if(this._stackhelper&&this._stackhelper instanceof AMI.VolumeRenderingHelper)break;this._stackhelper=new AMI.VolumeRenderingHelper(this._stack),this._stackhelper.uniforms.uTextureLUT.value=this._lut.texture,this._stackhelper.uniforms.uLut.value=1;break;case C.SLICES:if(this._stackhelper&&this._stackhelper instanceof AMI.StackHelper)break;this._stackhelper=new AMI.StackHelper(this._stack),this._stackhelper.bbox.visible=!1,this._stackhelper.border.color=I.colorValues.blue}},e.prototype.renderContainer=function(){var e=this;return i("div",null,i("div",{id:"lut-container"},i("div",{id:"lut-min"},"0.0"),i("div",{id:"lut-canvases",ref:function(t){return e._lutCanvases=t}}),i("div",{id:"lut-max"},"1.0")),i("div",{id:"container",ref:function(t){return e._canvasContainer=t}}))},e.prototype.renderDisplayToggle=function(){var e=this;return this.display!==C.MESH?i("ion-item",{id:"mode"},i("ion-icon",{name:"eye"}),i("ion-select",{id:"modeSelect",interface:"popover",value:this.display,"ok-text":"OK","cancel-text":"Cancel",onIonChange:function(t){return e.appSetDisplay(t.detail.value)}},i("ion-select-option",{value:"slices"},"Slices"),i("ion-select-option",{value:"volume"},"Volume"))):null},e.prototype.renderToolsToggle=function(){var e=this;return this.toolsVisible?i("ion-item",null,i("ion-icon",{name:"create"}),i("ion-toggle",{onIonChange:function(t){return e.appSetToolsEnabled(t.detail.checked)}})):null},e.prototype.renderTools=function(){var e=this;return this.toolsVisible&&this.toolsEnabled?i("ion-item",null,i("ion-label",null,"Tool Type"),i("ion-select",{value:this.toolType,interface:"popover",placeholder:"None","ok-text":"OK","cancel-text":"Cancel",onIonChange:function(t){return e.appSetToolType(t.detail.value)}},this.angleToolEnabled?i("ion-select-option",{value:"angle"},"Angle"):null,this.annotationToolEnabled?i("ion-select-option",{value:"annotation"},"Annotation"):null,this.rulerToolEnabled?i("ion-select-option",{value:"ruler"},"Ruler"):null)):null},e.prototype.renderOptionsToggle=function(){var e=this;if(this.optionsVisible)return i("ion-item",null,i("ion-icon",{name:"options"}),i("ion-toggle",{onIonChange:function(t){return e.appSetOptionsEnabled(t.detail.checked)}}))},e.prototype.renderBoundingBoxEnabled=function(){var e=this;return i("ion-item",null,i("ion-label",null,"Bounding box"),i("ion-toggle",{checked:this.boundingBoxVisible,onIonChange:function(t){return e.appSetBoundingBoxVisible(t.detail.checked)}}))},e.prototype.renderOptions=function(){var e=this;switch(this.display){case C.SLICES:var t,n=Object.keys(H).indexOf(this.orientation.toUpperCase()),o=this._stack.zCosine;t=1===Math.round(o.x)?1:1===Math.round(o.y)?2:0;var s,r=Math.round((n+t)%3),a=Math.round((n+t+2)%3),l=this._stack.dimensionsIJK[Object.keys(this._stack.dimensionsIJK)[a]]-1;s=void 0===this.slicesIndex?Math.floor(l/2):this.slicesIndex;var h=1,c=this._stack.minMax[1]-this._stack.minMax[0],d=void 0;d=void 0===this.slicesWindowWidth?c/2:this.slicesWindowWidth;var u=this._stack.minMax[0],_=this._stack.minMax[1],p=void 0;return p=void 0===this.slicesWindowCenter?_/2:this.slicesWindowCenter,this._stackhelper.orientation=r,this._stackhelper.index=s,this._stackhelper.slice.windowWidth=d,this._stackhelper.slice.windowCenter=p,this.optionsVisible&&this.optionsEnabled?i("div",null,this.renderBoundingBoxEnabled(),i("ion-item",null,i("ion-label",null,"Index"),i("ion-range",{pin:"true",min:"0",max:l,value:s,onIonChange:this._slicesIndexChanged.bind(this)})),i("ion-item",null,i("ion-label",null,"Orientation"),i("ion-select",{id:"slicesOrientationSelect",interface:"popover",value:this.orientation,"ok-text":"OK","cancel-text":"Cancel",onIonChange:function(t){return e.appSetOrientation(t.detail.value)}},i("ion-select-option",{value:"coronal"},"Coronal (x)"),i("ion-select-option",{value:"saggital"},"Saggital (y)"),i("ion-select-option",{value:"axial"},"Axial (z)"))),i("ion-item",null,i("ion-icon",{name:"sunny"}),i("ion-range",{pin:"true",min:u,max:_,value:p,onIonChange:this._slicesWindowCenterChanged.bind(this)})),i("ion-item",null,i("ion-icon",{name:"contrast"}),i("ion-range",{pin:"true",min:h,max:c,value:d,onIonChange:this._slicesWindowWidthChanged.bind(this)}))):null;case C.VOLUME:var f;if(h=1,c=this._stack.minMax[1]-this._stack.minMax[0],d=void 0,d=void 0===this.volumeWindowWidth?c/2:this.volumeWindowWidth,u=this._stack.minMax[0],_=this._stack.minMax[1],p=void 0,p=void 0===this.volumeWindowCenter?_/2:this.volumeWindowCenter,this._stackhelper.uniforms.uSteps.value=f=void 0===this.volumeSteps?16:this.volumeSteps,this._stackhelper.windowWidth=d,this._stackhelper.windowCenter=p,this.optionsVisible&&this.optionsEnabled)return i("div",null,this.renderBoundingBoxEnabled(),i("ion-item",null,i("ion-label",null,"Steps"),i("ion-range",{min:1,max:128,value:f,pin:"true",onMouseUp:this._volumeStepsChanged.bind(this)})),i("ion-item",null,i("ion-icon",{name:"sunny"}),i("ion-range",{min:u,max:_,value:p,pin:"true",onMouseUp:this._volumeWindowCenterChanged.bind(this)})),i("ion-item",null,i("ion-icon",{name:"contrast"}),i("ion-range",{min:h,max:c,value:d,pin:"true",onMouseUp:this._volumeWindowWidthChanged.bind(this)})));case C.MESH:if(this.optionsVisible&&this.optionsEnabled)return i("div",null,this.renderBoundingBoxEnabled())}},e.prototype._slicesIndexChanged=function(e){this.appSetSlicesIndex(e.srcElement.value)},e.prototype._slicesWindowCenterChanged=function(e){this.appSetSlicesWindowCenter(e.srcElement.value)},e.prototype._slicesWindowWidthChanged=function(e){this.appSetSlicesWindowWidth(e.srcElement.value)},e.prototype._volumeStepsChanged=function(e){this.appSetVolumeSteps(e.srcElement.value)},e.prototype._volumeWindowCenterChanged=function(e){this.appSetVolumeWindowCenter(e.srcElement.value)},e.prototype._volumeWindowWidthChanged=function(e){this.appSetVolumeWindowWidth(e.srcElement.value)},e.prototype.renderControlPanel=function(){return this.srcLoaded?i("div",{id:"control-panel"},i("ion-app",null,this.renderDisplayToggle(),this.renderToolsToggle(),this.renderTools(),this.renderOptionsToggle(),this.renderOptions())):null},e.prototype.renderLoading=function(){if(this.src&&!this.srcLoaded)return i("div",{id:"spinner"},i("div",{class:"square"}))},e.prototype.render=function(){return i("div",null,this.renderContainer(),this.renderControlPanel(),this.renderLoading())},e.prototype.componentDidUpdate=function(){var e=this;this.srcLoaded?this._displayChanged?(this._displayChanged=!1,cancelAnimationFrame(this._requestAnimationFrame),this._canvasContainer.innerHTML="",this._createRenderer(),this._scene=new THREE.Scene,this._loadedDataParent=new THREE.Object3D,this._scene.add(this._loadedDataParent),this._stackhelper&&this._scene.add(this._stackhelper),this._maxEdgeDistance=this.display===C.MESH?X.setupMesh(this._loadedDataParent,this._meshObject,this._renderer):null,this._boundingBoxHelper=z.getBoundingBoxHelper(this.display,this._loadedDataParent,this._stackhelper),this._scene.add(this._boundingBoxHelper),this._boundingBoxHelper.visible=!1,this._sceneCenter=z.getGeometryCenter(this._boundingBoxHelper.geometry),this._maxEdgeDistance||(this._maxEdgeDistance=z.getBoundingMag(this._boundingBoxHelper.geometry)/2),this._scene.add(z.createSceneLights()),this._camera=z.createPerspectiveCamera(this._canvasContainer),this._createControls(),z.initialiseCameraFromScene(this._boundingBoxHelper.geometry,this._camera,this._controls),this._animate(),this.resize(),this.onLoaded.emit(this._stackhelper),this.appSetTHREEJSSceneNeedsUpdate(!0)):this._boundingBoxHelper.visible=this.boundingBoxVisible:X.loadSrc(this.src,this.display,this._canvasContainer).then(function(t){e._meshObject=t.obj,e._stack=t.stack,e.appSetSrcLoaded(!0)})},e.prototype._createWidgetFromRay=function(e){var t=z.getScreenspaceOffsets(this._canvasContainer);this._widgetRaycaster.setFromCamera({x:(e.clientX-t.left)/this._canvasContainer.offsetWidth*2-1,y:-(e.clientY-t.top)/this._canvasContainer.offsetHeight*2+1},this._camera);var n=null,i=z.castRay(this._widgetRaycaster,this.display,this._sceneCenter,this._camera,this._stackhelper,this._loadedDataParent);return i&&(n=z.createWidget(this._controls,this._controls.domElement,{toolParams:{scene:this._scene,displayMode:this.display,stackHelper:this._stackhelper,boundingBoxGeometry:this._boundingBoxHelper.geometry,orientation:this.orientation,loadedDataParent:this._loadedDataParent,hideMesh:!1},toolType:this.toolType,worldPosition:i.hitPosition,worldNormal:i.hitNormal},this._maxEdgeDistance))?(this._widgets.push(n.widget),this._scene.add(n.widget),n.activeHandles):-1},e.prototype._resetWidgets=function(){this._canvasContainer&&(this._canvasContainer.removeEventListener("mouseup",this._widgetMouseUpHandler),this._canvasContainer.removeEventListener("mousemove",this._widgetMouseMoveHandler),this._canvasContainer.removeEventListener("mousedown",this._widgetMouseDownHandler),this._widgets.forEach(function(e){e.free()}),this._widgets=[],this._widgetMouseUpHandler=this._widgetMouseUp.bind(this),this._widgetMouseMoveHandler=this._widgetMouseMove.bind(this),this._widgetMouseDownHandler=this._widgetMouseDown.bind(this),this._canvasContainer.addEventListener("mouseup",this._widgetMouseUpHandler,!1),this._canvasContainer.addEventListener("mousemove",this._widgetMouseMoveHandler,!1),this._canvasContainer.addEventListener("mousedown",this._widgetMouseDownHandler,!1))},e.prototype._widgetMouseUp=function(){if(this.display===C.VOLUME&&this._resetPixelDensity(),this.toolsEnabled){for(var e=0,t=this._widgets;e<t.length;e++){var n=t[e];if(n.active)return n.onEnd(),void this._reduceActive()}this._controls.enabled=!0,this.appSetTHREEJSSceneNeedsUpdate(!0)}},e.prototype._widgetMouseMove=function(e){if(this.toolsEnabled){this._activeWidgets>0&&this.display===C.VOLUME&&this._reducePixelDensity();for(var t="default",n=0,i=this._widgets;n<i.length;n++){var o=i[n];o.onMove(e),o.hovered&&(t="pointer")}this._canvasContainer.style.cursor=t,this.appSetTHREEJSSceneNeedsUpdate(!0)}},e.prototype._widgetMouseDown=function(e){if(this.display===C.VOLUME&&this._reducePixelDensity(),this.toolsEnabled){for(var t=0,n=this._widgets;t<n.length;t++){var i=n[t];if(i.hovered)return i.onStart(e),void this._setActive(1)}var o=this._createWidgetFromRay(e);-1!==o&&(this._controls.enabled=!1,this._setActive(o),this.appSetTHREEJSSceneNeedsUpdate(!0)),this._canvasContainer.style.cursor="default"}},e.prototype._flushWidgets=function(){var e=this;0===this._activeWidgets&&this._widgets.forEach(function(t){t.flushState(),e.appSetTHREEJSSceneNeedsUpdate(!0)})},e.prototype._createRenderer=function(){this._renderer=new THREE.WebGLRenderer({alpha:!0}),this._renderer.setSize(this._canvasContainer.offsetWidth,this._canvasContainer.offsetHeight),this._renderer.setClearColor(I.colorValues.black,1),this._renderer.setPixelRatio(window.devicePixelRatio),this._canvasContainer.appendChild(this._renderer.domElement)},e.prototype._createControls=function(){this._controls=new THREE.OrbitControls(this._camera,this._canvasContainer),this._controls.addEventListener("change",this._onControlsChange.bind(this)),this._controls.addEventListener("start",this._onControlsStart.bind(this)),this._controls.addEventListener("end",this._onControlsEnd.bind(this)),this._controls.maxPolarAngle=Math.PI/1.1,this._controls.screenSpacePanning=!0,this._controls.rotateSpeed=.75,this._controls.zoomSpeed=1.2,this._controls.enableDamping=!0,this._controls.dampingFactor=.25},e.prototype._onControlsChange=function(){this.appSetTHREEJSSceneNeedsUpdate(!0)},e.prototype._onControlsStart=function(){this.display===C.VOLUME&&this._stackhelper.uniforms&&this._reducePixelDensity()},e.prototype._onControlsEnd=function(){this.display===C.VOLUME&&this._stackhelper.uniforms&&this._resetPixelDensity()},e.prototype._resetPixelDensity=function(){var e=this;setTimeout(function(){e._renderer.setPixelRatio(window.devicePixelRatio*e._renderQuality),e._renderer.setSize(e._canvasContainer.offsetWidth,e._canvasContainer.offsetHeight),e.appSetTHREEJSSceneNeedsUpdate(!0)},100)},e.prototype._reducePixelDensity=function(){this._renderer.setPixelRatio(.1*window.devicePixelRatio*this._renderQuality),this._renderer.setSize(this._canvasContainer.offsetWidth,this._canvasContainer.offsetHeight),this.appSetTHREEJSSceneNeedsUpdate(!0)},e.prototype._updateWidgets=function(){for(var e=0,t=this._widgets;e<t.length;e++)t[e].update()},e.prototype._animate=function(){var e=this,t=(new Date).getTime();this._deltaTime=t-this._lastTime||0,this._lastTime=t,this._controls.update(),this._updateWidgets(),this.display===C.VOLUME?this.THREEJSSceneNeedsUpdate&&(this._renderer.render(this._scene,this._camera),setTimeout(function(){e.appSetTHREEJSSceneNeedsUpdate(!1),e._renderer.render(e._scene,e._camera)},3*this._deltaTime)):this._renderer.render(this._scene,this._camera),this._requestAnimationFrame=requestAnimationFrame(function(){e._animate()})},e.prototype.resize=function(){this.srcLoaded&&(this._camera.aspect=this._canvasContainer.offsetWidth/this._canvasContainer.offsetHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(this._canvasContainer.offsetWidth,this._canvasContainer.offsetHeight),this._resizeWidgets())},e.prototype._resizeWidgets=function(){this._updateWidgets(),this.appSetTHREEJSSceneNeedsUpdate(!0)},Object.defineProperty(e,"is",{get:function(){return"ami-viewer"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"properties",{get:function(){return{angleToolEnabled:{state:!0},annotationToolEnabled:{state:!0},boundingBoxVisible:{state:!0},display:{state:!0,watchCallbacks:["watchDisplay"]},dracoDecoderPath:{type:String,attr:"draco-decoder-path"},optionsEnabled:{state:!0},optionsVisible:{state:!0},orientation:{state:!0,watchCallbacks:["watchOrientation"]},resize:{method:!0},rulerToolEnabled:{state:!0},setAngleToolEnabled:{method:!0},setAnnotationToolEnabled:{method:!0},setBoundingBoxVisible:{method:!0},setDisplay:{method:!0},setOptionsVisible:{method:!0},setRulerToolEnabled:{method:!0},setSrc:{method:!0},setToolsVisible:{method:!0},slicesIndex:{state:!0},slicesWindowCenter:{state:!0},slicesWindowWidth:{state:!0},src:{state:!0},srcLoaded:{state:!0,watchCallbacks:["watchSrcLoaded"]},store:{context:"store"},THREEJSSceneNeedsUpdate:{state:!0},toolsEnabled:{state:!0},toolsVisible:{state:!0},toolType:{state:!0},volumeSteps:{state:!0},volumeWindowCenter:{state:!0},volumeWindowWidth:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(e,"events",{get:function(){return[{name:"onLoaded",method:"onLoaded",bubbles:!0,cancelable:!0,composed:!0}]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"style",{get:function(){return"ami-viewer.sc-ami-viewer{background-color:#000}#container.sc-ami-viewer{left:0;right:0;top:0;bottom:0;position:absolute;width:100%;height:100%;overflow:hidden}#control-panel.sc-ami-viewer{width:100%}\@media only screen and (min-width:500px){#control-panel.sc-ami-viewer{max-width:300px}}#debug.sc-ami-viewer{position:fixed;top:0;right:0}#lut-container.sc-ami-viewer{display:none}.widgets-handle.sc-ami-viewer{position:absolute;border:1px solid #fff;border-radius:50%;width:10px;height:10px;margin:-6px;z-index:0}.widgets-line.sc-ami-viewer{width:1px;height:1px}.widgets-dashline.sc-ami-viewer, .widgets-line.sc-ami-viewer{position:absolute;margin-top:-.5px}.widgets-dashline.sc-ami-viewer{border-top:1px dashed #fff}.widgets-dashline.sc-ami-viewer:before, .widgets-line.sc-ami-viewer:before{content:\" \";position:absolute;height:12px;left:0;right:0;margin-top:-6px}.widgets-rectangle.sc-ami-viewer{position:absolute;border:1px solid;margin:-1px}.widgets-rectangle-helper.sc-ami-viewer{position:absolute;border:1px dashed;margin:-1px}.widgets-ellipse.sc-ami-viewer{position:absolute;border:1px solid;border-radius:50%;margin:-1px;z-index:0}.widgets-label.sc-ami-viewer{position:absolute;border:1px solid;background-color:rgba(0,0,0,.7);color:#fff;padding:4px;z-index:0}.progress.container.sc-ami-viewer{position:absolute;top:auto!important;bottom:0!important}.progress.container.sc-ami-viewer   .load.progress.sc-ami-viewer, .progress.container.sc-ami-viewer   .parse.progress.sc-ami-viewer{border:none!important;height:4px!important;background-color:#fff!important}#spinner.sc-ami-viewer{position:absolute;left:50%;top:50%}#spinner.sc-ami-viewer   .square.sc-ami-viewer{margin:0 0 0 -15px;background-color:#fff;width:30px;height:30px;-webkit-animation:sk-rotateplane 1.2s ease-in-out infinite;-moz-animation:sk-rotateplane 1.2s infinite ease-in-out;animation:sk-rotateplane 1.2s ease-in-out infinite}\@-webkit-keyframes sk-rotateplane{0%{-webkit-transform:perspective(120px)}50%{-webkit-transform:perspective(120px) rotateY(180deg)}to{-webkit-transform:perspective(120px) rotateY(180deg) rotateX(180deg)}}\@keyframes sk-rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg)}to{transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg);-webkit-transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg)}}"},enumerable:!0,configurable:!0}),e}();e.AmiViewer=F,Object.defineProperty(e,"__esModule",{value:!0})});